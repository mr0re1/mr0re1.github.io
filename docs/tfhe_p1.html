<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🗿</text></svg>">
    <title>orlov blog</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H2T5FV9H0R"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-H2T5FV9H0R');
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="static/code.css" rel="stylesheet">
    
</head>


<body>
    <div class="container">
         <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">🗿 orlov blog</a>
    </div>
</nav>
        <h1>TFHE: guide walkthrough. Part 1</h1>
        <div>
            <span>Posted on 2023-08-15</span>
            <span>|</span>
            <span>
                <a href="https://github.com/mr0re1/mr0re1.github.io/blob/master/posts/tfhe_p1.ipynb">source code</a>
            </span>
        </div>
        <hr>
        <div>
        <p>Walkthrough of <a href="https://eprint.iacr.org/2021/1402">Guide to
Fully Homomorphic Encryption over the [Discretized] Torus</a> by Marc
Joye. Part 1.</p>
<pre><code>@misc{cryptoeprint:2021/1402,
      author = {Marc Joye},
      title = {Guide to Fully Homomorphic Encryption over the [Discretized] Torus},
      howpublished = {Cryptology ePrint Archive, Paper 2021/1402},
      year = {2021},
      note = {\url{https://eprint.iacr.org/2021/1402}},
      url = {https://eprint.iacr.org/2021/1402}
}</code></pre>
<h1 id="torus-and-torus-polynomials">1.1 Torus and Torus
Polynomials</h1>
<p><em>Example 1.</em> Take for example <span class="math inline">\(a =
\frac{2}{5}, b = \frac{4}{5}\)</span> and <span class="math inline">\(c
= \frac{1}{3}\)</span>.</p>
<p>Over <span class="math inline">\(\mathbb{T}\)</span>, we get</p>
<p><span class="math inline">\((a + b) \times c = \frac{1}{5} \times
\frac{1}{3} = \frac{1}{15}\)</span> and</p>
<p><span class="math inline">\(a \times c + b \times c = \frac{2}{15} +
\frac{4}{15} = \frac{6}{15} = \frac{2}{5}\)</span>, a contradiction.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> T(Fraction): <span class="co"># represents the element of thorus</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__new__</span>(cls, n, d):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">super</span>().<span class="fu">__new__</span>(cls, n <span class="op">%</span> d, d)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>, other):  <span class="co"># addition</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        f <span class="op">=</span> Fraction.<span class="fu">__add__</span>(<span class="va">self</span>, other)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> T(f.numerator, f.denominator)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dot(<span class="va">self</span>, n): <span class="co"># external product</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> T(n <span class="op">*</span> <span class="va">self</span>.numerator, <span class="va">self</span>.denominator)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> T(<span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> T(<span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> T(<span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: * - is internal product, wich IS NOT DEFINED on T. </span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># To perform it we move elements to real numbers (represented by Fraction)</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((a <span class="op">+</span> b) <span class="op">*</span> c, <span class="st">&quot;!=&quot;</span>, <span class="co"># (𝑎+𝑏)×𝑐</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      (a <span class="op">*</span> c) <span class="op">+</span> (b <span class="op">*</span> c)) <span class="co"># 𝑎×𝑐+𝑏×𝑐</span></span></code></pre></div>
<pre><code>1/15 != 2/5</code></pre>
<p><em>Example 2.</em> Take <span class="math inline">\(k = 2, l = 3, a
= \frac{2}{5}\)</span> and <span class="math inline">\(b =
\frac{4}{5}\)</span>.</p>
<p>We get <span class="math inline">\((k + l) \cdot a = 5 \cdot
\frac{2}{5} = 0\)</span> and <span class="math inline">\(k \cdot a + l
\cdot a = \frac{4}{5} + \frac{1}{5} = 0\)</span>, as expected.</p>
<p>We also get <span class="math inline">\(k \cdot (a + b) = 2 \cdot
\frac{1}{5} = \frac{2}{5}\)</span> and <span class="math inline">\(k
\cdot a + k \cdot b = \frac{4}{5} + \frac{3}{5} =
\frac{2}{5}\)</span>.</p>
<p>Finally, taking <span class="math inline">\(t = a =
\frac{2}{5}\)</span>, we get <span class="math inline">\(k \cdot (l
\cdot t) = 2 \cdot \frac{1}{5} = \frac{2}{5}\)</span> and <span
class="math inline">\((kl) \cdot t = 6 \cdot \frac{2}{5} =
\frac{2}{5}\)</span>, as expected.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> a <span class="op">=</span> T(<span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> T(<span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  a.dot(k <span class="op">+</span> l), <span class="st">&quot;=&quot;</span>,   <span class="co"># (𝑘+𝑙)⋅𝑎</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  a.dot(k) <span class="op">+</span> a.dot(l)) <span class="co"># 𝑘⋅𝑎+𝑙⋅𝑎</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  (a <span class="op">+</span> b).dot(k), <span class="st">&quot;=&quot;</span>, <span class="co"># 𝑘⋅(𝑎+𝑏)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  a.dot(k) <span class="op">+</span> b.dot(k)) <span class="co"># 𝑘⋅𝑎+𝑘⋅𝑏</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  t.dot(l).dot(k), <span class="st">&quot;=&quot;</span>,<span class="co"># 𝑘⋅(𝑙⋅𝑡)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  t.dot(l <span class="op">*</span> k))        <span class="co"># (𝑘𝑙)⋅𝑡</span></span></code></pre></div>
<pre><code>0 = 0
2/5 = 2/5
2/5 = 2/5</code></pre>
<p><em>Example 3.</em> Take for example <span
class="math inline">\(\mathscr{p}(X) = \frac{2}{5}X +
\frac{1}{3}\)</span>, <span class="math inline">\(\mathscr{q}(X) =
\frac{4}{5}X + \frac{1}{2}\)</span>, and <span
class="math inline">\(\mathscr{r}(X) = 2X + 7\)</span>.</p>
<p>Then <span class="math inline">\((\mathscr{p} + \mathscr{q})(X) =
\frac{1}{5}X + \frac{5}{6}\)</span></p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (T(<span class="dv">1</span>, <span class="dv">3</span>), T(<span class="dv">2</span>, <span class="dv">5</span>)) <span class="co"># 1/3 + 2/5X</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> (T(<span class="dv">1</span>, <span class="dv">2</span>), T(<span class="dv">4</span>, <span class="dv">5</span>)) <span class="co"># 1/2 + 4/5X</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> (<span class="dv">7</span>, <span class="dv">2</span>)             <span class="co">#   7 + 2X</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(p[<span class="dv">0</span>] <span class="op">+</span> q[<span class="dv">0</span>], p[<span class="dv">1</span>] <span class="op">+</span> q[<span class="dv">1</span>]) <span class="co"># p + q</span></span></code></pre></div>
<pre><code>5/6 1/5</code></pre>
<p>and</p>
<p><span class="math inline">\((\mathscr{r} \cdot \mathscr{p})(X) =
\frac{4}{5}X^2 + \frac{7}{15}X + \frac{1}{3} = ...\)</span></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> [T(<span class="dv">0</span>, <span class="dv">1</span>)] <span class="op">*</span> <span class="dv">3</span> <span class="co"># 0 + 0X + 0X^2</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        t[i <span class="op">+</span> j] <span class="op">+=</span> p[i].dot(r[j])</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="op">*</span>t)</span></code></pre></div>
<pre><code>1/3 7/15 4/5</code></pre>
<p><span class="math inline">\(...= -\frac{4}{5} + \frac{7}{15}X +
\frac{1}{3} = \frac{7}{15}X + \frac{8}{15}\)</span></p>
<p>Recall that polynomials are defined modulo <span
class="math inline">\(X^2 + 1\)</span> (and thus <span
class="math inline">\(X^2 ≡ −1\)</span>).</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(t[<span class="dv">0</span>] <span class="op">+</span> t[<span class="dv">2</span>].dot(<span class="op">-</span><span class="dv">1</span>), t[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>8/15 7/15</code></pre>
<h1 id="discretized-torus-jaxite">1.2 Discretized Torus (+Jaxite)</h1>
<p>Later in this walkthrough, instead of implementing it from scratch, I
am going to use <a href="https://github.com/google/jaxite">Jaxite</a>,
an FHE library by Google.</p>
<p>Let’s compute the <span class="math inline">\((\mathscr{r} \cdot
\mathscr{p})(X)\)</span> from <em>Example 3</em> using Jaxite.</p>
<p>For practical reasons, thorus elements are not represented with
fractions, but rather as integers modulo <span
class="math inline">\(q\)</span>.</p>
<p>Consider <span class="math inline">\(\mathscr{p}(X) = \frac{2}{5}X +
\frac{1}{3}\)</span> from <span
class="math inline">\(\mathbb{T}_2[X]\)</span>,</p>
<p>it can be represented as <span
class="math inline">\(\mathscr{\overline{p}}(X) = 6X + 5\)</span> in
<span class="math inline">\(\mathbb{Z}_{{2},{15}}[X]\)</span>, and</p>
<p><span class="math inline">\((\mathscr{r} \cdot
\mathscr{\overline{p}})(X) = 7X + 8\)</span> in <span
class="math inline">\(\mathbb{Z}_{{2},{15}}[X]\)</span>.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jaxite.jaxite_lib.matrix_utils <span class="im">import</span> poly_mul</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> jnp.array([<span class="dv">5</span>, <span class="dv">6</span>]) <span class="co"># in Z_{2,15}[X]</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> jnp.array([<span class="dv">7</span>, <span class="dv">2</span>]) <span class="co"># in Z[X]</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># poly_mul will account for modulo (X^2 + 1), but not for modulo 15, do it manually</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(poly_mul(r, p) <span class="op">%</span> <span class="dv">15</span>)</span></code></pre></div>
<pre><code>[8 7]</code></pre>
<h1 id="notation">1.3 Notation</h1>
<p><em>Example 5.</em> The vector <span
class="math inline">\(\pmb{\mathcal{v}} = (\pmb{3}, \pmb{4}) \in
\mathbb{Z}^2\)</span> is regarded as the row matrix <span
class="math inline">\(\begin{pmatrix} 3 &amp; 4 \end{pmatrix} \in
\mathbb{Z}^{1 \times 2}\)</span>, and if <span
class="math inline">\(\pmb{A} = \begin{pmatrix} 1 &amp; 2 \\ 0 &amp; 1
\end{pmatrix}\)</span> then <span
class="math inline">\(\pmb{\mathcal{v}A} = \begin{pmatrix} 3 &amp; 10
\end{pmatrix} = (\pmb{3}, \pmb{10})\)</span></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> jnp.array([[<span class="dv">3</span>, <span class="dv">4</span>]]) </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> jnp.array([[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">0</span>, <span class="dv">1</span>]])</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(jnp.matmul(v, A))</span></code></pre></div>
<pre><code>[[ 3 10]]</code></pre>
        </div>

        <div class="giscus-wrap container">
            <script src="https://giscus.app/client.js" data-repo="mr0re1/mr0re1.github.io"
                data-repo-id="MDEwOlJlcG9zaXRvcnk0MjE0ODk2Mw==" data-category="Posts discussions"
                data-category-id="DIC_kwDOAoMkY84CYxFJ" data-mapping="pathname" data-strict="0"
                data-reactions-enabled="0" data-emit-metadata="0" data-input-position="bottom" data-theme="light"
                data-lang="en" crossorigin="anonymous" async>
                </script>
        </div>
    </div>
</body>

</html>